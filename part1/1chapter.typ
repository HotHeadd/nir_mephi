= Анализ задач мониторинга памяти

Современные прикладные системы одновременно растут по сложности и по требованиям к надёжности, из-за чего ошибки работы с памятью всё чаще проявляются не как единичные дефекты, а как системный источник деградации и уязвимостей.
Оперативная память и механизмы виртуальной памяти связывают воедино вычисления, ввод-вывод и безопасность, поэтому наблюдаемость поведения памяти становится отдельной инженерной задачей.
В реальных системах важно уметь отличать нормальные паттерны обращений к памяти от аномальных, а также связывать изменения поведения с конкретными компонентами и фазами выполнения.
При этом мониторинг памяти не сводится к одной метрике: на практике различают наблюдение состояния памяти как ресурса и наблюдение событий доступа к памяти на уровне процессов и потоков.

== Введение в задачи мониторинга памяти

Перед формулированием конкретных задач полезно зафиксировать, что в Linux термин «память процесса» описывает не физические адреса RAM, а виртуальное адресное пространство, отображаемое ядром на физические страницы.
Это означает, что наблюдаемые адреса и диапазоны в первую очередь имеют смысл в рамках процесса и его отображений, а не как «позиции» в оперативной памяти.

На уровне анализа поведения приложений центральной единицей становится событие доступа с атрибутами адреса, типа операции и контекста выполнения.
Контекст позволяет связывать события с потоком, модулем и фазой работы программы и тем самым повышает интерпретируемость результатов.
В практических сценариях без контекста мониторинг быстро превращается в набор разрозненных адресов, который сложно сопоставить с логикой приложения.
В дальнейшем под мониторингом памяти преимущественно понимается мониторинг доступов к памяти целевого процесса в Linux с возможностью контекстной фильтрации.

=== Основные понятия мониторинга памяти

Оперативная память (RAM -- Random Access Memory) представляет собой основной высокоскоростной ресурс хранения данных во время выполнения программ.
В Linux доступ приложений к RAM опосредован механизмом виртуальной памяти: каждый процесс имеет виртуальное адресное пространство, разделённое на диапазоны (отображения), которые ядро отображает на физические страницы.

Для описания поведения процесса на уровне памяти удобно использовать понятия «виртуальный адрес», «диапазон виртуальных адресов» и «отображение» (mapping), то есть связанный диапазон адресов с атрибутами прав доступа и происхождения данных (анонимная память или отображение файла).
Чтобы визуально закрепить устройство адресного пространства процесса и связь его областей с описателями памяти ядра Linux, далее приведена упрощённая схема, отражающая типичные сегменты (text, data, bss), динамические области (heap и mmap) и стек, а также роль структуры mm_struct как описателя адресного пространства.

#figure( image("assets/process-memo.png"), caption: [Упрощённая схема виртуального адресного пространства процесса Linux], )

Схема носит иллюстративный характер и показывает типичную композицию областей процесса, однако конкретные адреса и взаимное расположение регионов зависят от архитектуры, настроек системы и механизмов рандомизации (например, ASLR -- Address Space Layout Randomization).
Тем не менее она полезна для постановки задач мониторинга, потому что подчёркивает, что наблюдение ведётся по виртуальным адресам процесса, а смысл событий зависит от того, в какой области произошёл доступ.
Например, обращения к стеку и куче часто связаны с ошибками управления памятью, а обращения к отображениям (mmap) отражают как загрузку модулей и библиотек, так и работу с file-backed памятью.
На практике мониторинг событий доступа интерпретируется через принадлежность адресов к таким областям и через их права (чтение, запись, исполнение), что позволяет локализовать аномалии и повышать интерпретируемость результатов.

Мониторинг памяти в инженерной практике включает два взаимодополняющих направления.
Первое направление -- мониторинг состояния памяти как ресурса: выявление утечек, роста потребления, подкачки, давления на память и аномалий распределения памяти между компонентами.
Второе направление -- мониторинг доступов к памяти: фиксация операций чтения (read), записи (write) и исполнения (execute) в адресном пространстве процесса с возможностью атрибуции событий к контексту выполнения.
Для задач данной НИР ключевым является второе направление, поскольку оно позволяет связывать аномальные обращения к памяти с конкретными потоками и программными компонентами.

=== Роль мониторинга памяти в современных вычислительных системах
Современные вычислительные системы состоят из центрального процессора, оперативной памяти и подсистемы ввода-вывода, причём общая производительность приложений во многом определяется скоростью доступа к данным.
Оперативная память выполняет роль хранилища данных и промежуточного буфера, обеспечивающего выполнение программ и обмен с внешними устройствами.
При росте объёмов данных и усложнении программ ограничения подсистемы памяти становятся одним из главных факторов, сдерживающих производительность вычислений, что в литературе связывают с явлением _memory bottleneck_.

Исследования архитектуры вычислительных систем подчёркивают, что задержки и пропускная способность памяти являются критическими ограничителями эффективности вычислений, особенно при масштабировании нагрузки и росте параллелизма @mutlu2014research.
По мере роста требований приложений к обработке данных ограничения проявляются сильнее: растёт значение пропускной способности, латентности и эффективности использования интерфейсов памяти @liu2021study.
В такой ситуации наблюдение поведения памяти позволяет обнаруживать «узкие места», которые могут оставаться незаметными при анализе только процессорной нагрузки или суммарного потребления ресурсов @pagani2022autoprofile.
Практическая ценность мониторинга здесь заключается в том, что он позволяет переходить от общих симптомов (деградация, рост потребления) к локализуемым причинам (конкретные диапазоны, потоки и фазы выполнения).

=== Мониторинг памяти как инструмент безопасности
Подсистема памяти является критической областью не только для производительности, но и для информационной безопасности.
Ошибки управления памятью, включая выход за пределы буфера, обращение к освобождённой памяти и некорректные операции с указателями, приводят к нарушению целостности данных, аварийному завершению программ и создают основу для эксплуатации уязвимостей @memory_safety_vulns.
Такие ошибки лежат в основе широкого класса атак, где злоумышленник стремится либо изменить поток исполнения программы, либо получить доступ к чувствительным данным процесса.

Классическим примером является переполнение буфера, позволяющее повлиять на управляющие структуры и вызвать отклонение потока исполнения; развитие этой идеи включает атаки повторного использования кода, такие как ROP (Return-Oriented Programming), которые комбинируют фрагменты уже существующего кода для обхода ряда защитных механизмов.
С практической точки зрения мониторинг поведения памяти важен тем, что позволяет фиксировать аномальные паттерны доступа (неестественные записи в чувствительные диапазоны, нетипичные траектории исполнения, повторяемые обращения к определённым регионам), которые могут выступать индикаторами эксплуатации уязвимостей.
По сравнению со статическим анализом мониторинг в реальном времени отражает фактическое поведение программы в условиях эксплуатации и тем самым помогает точнее оценивать угрозы и последствия компрометации @car2023systemwide_detection.


== Основные сценарии использования
В рамках анализа задач мониторинга памяти можно выделить несколько ключевых сценариев, которые направлены на защиту данных и обеспечение безопасности приложений и операционной системы. Рассмотрим два основных из них.

=== Защита обрабатываемой информации в памяти
Одним из важнейших сценариев использования инструмента является защита конфиденциальных данных, которые обрабатываются в памяти процесса. @chen2020survey В современных приложениях часто содержится информация, которая требует защиты, например, ключи шифрования, пароли, персональная информация и другие чувствительные данные.

Мониторинг доступа к этим данным в памяти помогает выявить несанкционированные операции с конфиденциальной информацией. Инструмент для мониторинга памяти фиксирует все операции с памятью, включая чтение и запись в области, где могут храниться такие данные. В случае выявления доступа к защищенным данным инструмент записывает это событие в отчет, указывая:
- процесс, который осуществил доступ,
- тип операции,
- адрес памяти, к которому был произведен доступ.

Это позволяет позже провести анализ событий, выявив возможные попытки несанкционированного доступа к конфиденциальной информации. Этот сценарий особенно полезен для отслеживания атак, таких как утечка данных, инъекции кода или другие попытки получения доступа к защищенным данным.

=== Контроль целостности глобальных флагов в памяти
Другим важным направлением является контроль целостности критических данных, таких как глобальные флаги аутентификации, указатели и другие внутренние переменные, которые играют ключевую роль в логике работы программ @chen2020survey. Нарушение целостности этих данных может привести к атакам, направленным на манипулирование внутренним состоянием приложения или операционной системы.

Инструмент фиксирует все изменения в таких данных, записывая в отчет каждую операцию с соответствующими флагами и указателями. Как и в прошлом сценарии, инструмент фиксирует основные параметры активности (тип операции, процесс, адрес памяти) в отчете.
Такой мониторинг позволяет создать полный отчет о целостности критических данных и служит основой для дальнейшего анализа на предмет возможных атак, например, изменения флагов аутентификации или попыток манипулирования внутренним состоянием программы.

== Основные задачи
=== Наблюдение операций чтения, записи и исполнения в память

Мониторинг доступа к памяти на уровне процесса включает наблюдение трёх фундаментальных типов операций: чтение (read), запись (write) и исполнение (execute) в адресном пространстве процесса.
Чтение описывает получение данных из памяти в регистры или внутренние буферы процессора, запись -- изменение содержимого памяти, а исполнение -- выборку и выполнение инструкций, расположенных по адресам в виртуальном адресном пространстве.
В терминах мониторинга каждая операция характеризуется типом доступа, адресом (или диапазоном адресов), объёмом затронутых данных и моментом времени.

На практике события доступа интерпретируются не по одиночке, а как последовательности и паттерны: повторяемые записи в один диапазон могут указывать на неэффективные паттерны обновления данных или на активность, изменяющую критичные структуры; частые обращения к одним и тем же данным могут отражать особенности локальности и поведения алгоритма @sayas2025locality.
С точки зрения безопасности особый интерес представляют случаи, когда характер исполнений или записей в память становится нетипичным для нормального профиля программы, что может сопровождать эксплуатацию уязвимостей управления памятью, включая переполнения буфера @owasp_buffer_overflow.
Для корректного анализа важно помнить, что в современных системах исполнение произвольных данных часто ограничено политиками прав страниц; поэтому наблюдение исполнения используется как индикатор изменений поведения исполнения и привязки к диапазонам, а не как предположение, что «данные всегда исполняются».

=== Определение наблюдаемого события доступа к памяти

Для согласованного мониторинга необходимо формально определить параметры наблюдаемого события доступа к памяти.
Ниже перечислены параметры, которые в большинстве сценариев являются минимально достаточными для анализа производительности и безопасности:

+ *адрес доступа* -- виртуальный адрес в адресном пространстве процесса, либо границы диапазона, если событие агрегируется по региону;

+ *тип доступа* -- чтение, запись или исполнение, то есть принадлежность события к классу R/W/X;

+ *размер доступа* -- объём данных, затронутых событием (для анализа интенсивности и для различения, например, точечных и блочных операций);

+ *временная характеристика* -- временная метка или порядок события, позволяющие анализировать частоту, повторяемость и причинно-следственные связи между событиями;

+ *контекст выполнения* -- идентификатор процесса и потока, а также дополнительная информация, позволяющая привязать событие к коду (например, модуль выполнения) и к управляющим действиям ОС (например, системный вызов, изменивший карту памяти).

Указание физического адреса RAM для задач мониторинга доступа к памяти в пользовательском адресном пространстве обычно не требуется, поскольку анализ строится в терминах виртуальных адресов процесса и его отображений.

=== Атрибуция доступа к памяти и контекстная фильтрация

Атрибуция доступа к памяти -- это процесс привязки события доступа к конкретному потоку, инструкции, функции, модулю, системному вызову или адресу в виртуальном адресном пространстве. Этот процесс позволяет точно идентифицировать, какой элемент программы вызывает операцию с памятью и в каком контексте. В результате, атрибуция помогает локализовать проблему, будь то ошибка в программе или уязвимость безопасности, и отслеживать её происхождение, что критически важно для диагностики производительности или безопасности системы. Виды атрибутов:

+ *поток* -- мониторинг на уровне потоков позволяет определить, какой из множества параллельных потоков выполняет операции с памятью. В многозадачных и многопроцессорных системах каждый поток может работать с разными участками памяти, что делает важным анализ на уровне потоков для мониторинга параллельных вычислений и выявления узких мест;

+ *модуль* -- привязка события к исполняемому файлу или разделяемой библиотеке помогает связывать обращения к памяти с конкретными компонентами и зависимостями;

+ *функция или инструкция* -- более точная привязка к месту в коде позволяет локализовать проблемный фрагмент, однако на практике степень точности зависит от доступности информации сопоставления адресов к коду (например, наличия отладочной информации DWARF @dwarf5_standard и таблиц символов ELF @gdb_symbols);

+ *системный вызов* -- системные вызовы не «выполняют» чтения и записи пользовательского кода напрямую, но часто задают контекст изменения карты памяти и буферов (выделение отображений, смена прав, операции ввода-вывода), поэтому полезно связывать события доступа с близкими по времени управляющими действиями ОС @ji2017understanding;

+ *диапазон в виртуальном адресном пространстве* -- отнесение адреса к стеку, куче, анонимному отображению или отображению файла облегчает интерпретацию событий и помогает выделять чувствительные зоны для анализа.

Контекстная фильтрация -- это выделение подмножества событий, которые имеют значение для конкретной задачи анализа.
В отличие от атрибуции, которая дополняет событие метаданными о том, кто и где в программе инициировал доступ, контекстная фильтрация использует уже полученные атрибуты как условия отбора и тем самым уменьшает объём наблюдений и повышает отношение сигнал/шум.

Фильтрация позволяет ограничивать объём наблюдений, повышать отношение сигнал/шум и делать мониторинг применимым в реальных сценариях.
Типичные критерии фильтрации включают тип доступа (R/W/X), выбранные диапазоны виртуальных адресов, конкретные потоки или модули, а также ограничение наблюдений событиями, происходящими в заданном системном контексте (например, после выделения нового отображения или смены прав страниц).



== Трудности и ограничения

=== Накладные расходы
Одной из основных проблем при мониторинге доступа к памяти является значительная накладная нагрузка, которую он накладывает на систему. Это связано с тем, что для мониторинга всех операций с памятью требуется постоянный контроль над огромным количеством данных, что может существенно снизить производительность системы. Как показывают исследования @mutlu2014research, полная трассировка операций доступа к памяти может быть практически непрактична, особенно на системах с высокими требованиями к скорости обработки данных и с большим числом одновременно выполняющихся процессов и потоков.

Основная сложность заключается в том, что мониторинг с максимальной детализацией требует больших вычислительных ресурсов. Для снижения накладных расходов разработаны различные методы выборочного мониторинга, которые могут ограничивать сбор данных до наиболее значимых операций. Например, использование специализированных фильтров, таких как eBPF (Extended Berkeley Packet Filter @linux_bpf_docs @gregg2019bpf), позволяет значительно уменьшить накладные расходы, не снижая при этом качества мониторинга. Тем не менее, даже такие методы могут быть неэффективными на крупных системах с большим объёмом данных, что ограничивает их применение в реальных условиях. Это также увеличивает сложность работы с данными, что делает анализ менее точным и более трудозатратным.

=== Масштабируемость

Масштабируемость -- это способность системы мониторинга эффективно работать с увеличивающимся объёмом данных при росте числа потоков, процессов или объёмов адресного пространства. По мере роста системы и количества взаимодействующих компонентов мониторинг должен оставаться эффективным, а его стоимость не должна пропорционально увеличиваться. Важно, чтобы мониторинг мог масштабироваться без значительного увеличения вычислительных затрат и обеспечивал работу в условиях больших объёмов данных.

Сложность масштабирования также заключается в поддержке мониторинга с сохранением точности в условиях параллельных вычислений, многозадачности и использования динамически изменяющихся виртуальных адресных пространств. Обработка данных должна происходить быстро и эффективно, а инструмент должен быть готов к увеличению числа потоков и процессов без значительного увеличения нагрузки на систему.

=== Неполнота наблюдений

Неполнота наблюдений -- это одна из значимых проблем, с которой сталкиваются системы мониторинга памяти. В условиях ограниченных ресурсов или при выборочном мониторинге часто возникает ситуация, когда некоторые события доступа к памяти пропускаются, что приводит к недооценке объёмов памяти, которые могут быть использованы неправильно или привести к проблемам с безопасностью.

Исследования показали, что высокая нагрузка на систему, особенно в многозадачных средах, значительно увеличивает вероятность пропуска данных при мониторинге. Например, системы динамического профилирования памяти часто сталкиваются с трудностью точного отслеживания всех операций из-за ограничений по частоте выборки и обработке больших объёмов данных @liu2021study. В многопоточных системах дополнительные проблемы возникают при анализе операций, связанных с параллельными потоками и процессами, что ещё больше усложняет задачу обеспечения полноты наблюдений. Это, в свою очередь, ведёт к неточности в анализе поведения программы и повышает вероятность пропусков критичных событий.

== Выводы

В данной главе рассматривались ключевые задачи мониторинга памяти в современных вычислительных системах, с акцентом на их роль в обеспечении безопасности и стабильности программ. Были рассмотрены основные аспекты мониторинга, включая отслеживание операций чтения, записи и исполнения в память, а также необходимость контекстной фильтрации для повышения точности анализа. Также было выделено значительное внимание важности мониторинга как инструмента для защиты данных. Определены основные сценарии использования инструментов мониторинга памяти. Были сформированы основные задачи и ограничения мониторинга доступа к памяти.

Основные задачи мониторинга памяти включают:
- отслеживание операций чтения, записи и исполнения в виртуальном адресном пространстве,
- атрибуцию этих операций к конкретным потокам, модулям, функциям или системным вызовам для более точного анализа,
- использование контекстной фильтрации для уменьшения объёма данных, что помогает сосредоточиться на наиболее значимых событиях.

Основные ограничения, с которыми сталкиваются системы мониторинга памяти, включают:

+ *накладные расходы*, связанные с высокой частотой мониторинга, что может негативно сказываться на производительности системы. Для решения этой проблемы необходимо найти баланс между частотой сбора данных и их детализацией, используя методы выборочного мониторинга, такие как фильтрация несущественных операций;

+ *ограничения в масштабируемости мониторинга*, когда системы должны эффективно обрабатывать увеличивающиеся объёмы данных, что требует интеграции лёгких технологий мониторинга, способных работать с минимальными затратами на сбор и обработку данных;

+ *проблемы с полнотой наблюдений*, которые могут возникать при высоких нагрузках на систему, что ведёт к пропуску событий. Для минимизации этой проблемы инструмент мониторинга должен включать возможность агрегации данных по диапазонам виртуальных адресов или времени, что позволяет снизить объём данных и сосредоточиться на наиболее значимых событиях.

Проектирование инструмента мониторинга должно учитывать эти ограничения и направлено на создание эффективной системы, которая будет обеспечивать высокий уровень детализации при минимальных накладных расходах и высокой производительности, что критично для успешного применения мониторинга в реальных условиях эксплуатации.